<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Football Visualization: Teams, Players, and Realistic Pitch</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      background-color: #021e3f;
      margin: 0;
      font-family: sans-serif;
      color: white;
    }
    h1 {
      text-align: center;
      margin-top: 1em;
    }
    #controls {
      width: 800px;
      margin: 0 auto;
      text-align: center;
    }
    select, label {
      margin: 0 8px;
    }
    #pitch {
      display: block;
      margin: 1em auto;
      background: #01643f; /* pitch color */
      border: 2px solid #ffffff;
    }
    /* Circles for Shots, Goals, Passes, Assists */
    .shots-circle {
      fill: red;
      stroke: white;
      stroke-width: 1;
    }
    .goals-circle {
      fill: magenta;
      stroke: white;
      stroke-width: 1;
    }
    .passes-circle {
      fill: gold;
      stroke: white;
      stroke-width: 1;
    }
    .assists-circle {
      fill: orange;
      stroke: white;
      stroke-width: 1;
    }
    /* Lines for Shots, Goals, Passes, Assists */
    .shots-line {
      stroke: red;
      stroke-width: 1.5;
      opacity: 0.8;
    }
    .goals-line {
      stroke: magenta;
      stroke-width: 1.5;
      opacity: 0.8;
    }
    .passes-line {
      stroke: gold;
      stroke-width: 1.5;
      opacity: 0.8;
    }
    .assists-line {
      stroke: orange;
      stroke-width: 1.5;
      opacity: 0.8;
    }
    /* Pitch Lines */
    .pitch-line {
      stroke: white;
      stroke-width: 2;
      fill: none;
    }
    /* Stats Section */
    #stats {
      width: 800px;
      margin: 1em auto;
      background: #021e3f;
      border: 1px solid #fff;
      padding: 1em;
    }
    #stats h2 {
      margin: 0.5em 0;
      color: #fff;
      text-align: center;
    }
    #stats ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #stats li {
      margin: 0.2em 0;
      cursor: pointer; /* Make the list items appear clickable */
    }
    #stats li:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>Football Visualization: Teams, Players, and Realistic Pitch</h1>

  <div id="controls">
    <!-- Team & Player dropdowns -->
    <label>Team:</label>
    <select id="teamSelect">
      <option value="All">All</option>
      <!-- More options appended dynamically -->
    </select>

    <label>Player:</label>
    <select id="playerSelect">
      <option value="All">All</option>
      <!-- More options appended dynamically -->
    </select>
    <br/><br/>

    <!-- Checkboxes -->
    <label><input type="checkbox" id="chkShots"> Shots</label>
    <label><input type="checkbox" id="chkGoals"> Goals</label>
    <label><input type="checkbox" id="chkPasses"> Passes</label>
    <label><input type="checkbox" id="chkAssists"> Assists</label>
    <label><input type="checkbox" id="chkDirections"> Directions</label>
  </div>

  <svg id="pitch" width="800" height="533"></svg>
  <!-- Using 800x533 so the 120x80 pitch ratio is roughly maintained (1.5). -->

  <!-- Stats section for Top Scorers and Top Teams -->
  <div id="stats">
    <h2>Top Scoring Players</h2>
    <ul id="playerList"></ul>
    <h2>Top Scoring Teams</h2>
    <ul id="teamList"></ul>
  </div>

  <script>
    // Basic pitch dimension: 120 x 80
    const svg = d3.select("#pitch");
    const width = +svg.attr("width");
    const height = +svg.attr("height");

    // Create scales for x and y: [0..120] -> [0..width], [0..80] -> [0..height]
    const xScale = d3.scaleLinear().domain([0, 120]).range([0, width]);
    const yScale = d3.scaleLinear().domain([0, 80]).range([0, height]);

    // Add a group for pitch lines
    const gPitchLines = svg.append("g").attr("class", "pitch-lines");

    // Draw the pitch lines (center line, penalty boxes, etc.)
    drawPitchLines();

    // Groups for circles & lines of each category
    const gShotsCircles = svg.append("g");
    const gShotsLines   = svg.append("g");
    const gGoalsCircles = svg.append("g");
    const gGoalsLines   = svg.append("g");
    const gPassesCircles= svg.append("g");
    const gPassesLines  = svg.append("g");
    const gAssistsCircles = svg.append("g");
    const gAssistsLines   = svg.append("g");

    // Load JSON
    d3.json("subset_bundesliga2.json").then(data => {
      console.log("Data loaded:", data.length);

      // 1) Split data into Shots (non-goal), Goals, Passes, Assists
      const shots = data.filter(d => d.type === "Shot" && d.shot_outcome !== "Goal");
      const goals = data.filter(d => d.type === "Shot" && d.shot_outcome === "Goal");
      const passes = data.filter(d => d.type === "Pass" && !d.pass_shot_assist);
      const assists = data.filter(d => d.type === "Pass" && d.pass_shot_assist != null);

      console.log("Shots:", shots.length);
      console.log("Goals:", goals.length);
      console.log("Passes:", passes.length);
      console.log("Assists:", assists.length);

      // 2) Gather unique teams & players
      const allTeams = Array.from(new Set(data.map(d => d.team).filter(Boolean))).sort();
      const allPlayers = Array.from(new Set(data.map(d => d.player).filter(Boolean))).sort();

      // Populate Team dropdown
      const teamSelect = document.getElementById("teamSelect");
      allTeams.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.text = t;
        teamSelect.appendChild(opt);
      });

      // Populate Player dropdown
      const playerSelect = document.getElementById("playerSelect");
      allPlayers.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.text = p;
        playerSelect.appendChild(opt);
      });

      // 3) Draw circles
      gShotsCircles.selectAll(".shots-circle")
        .data(shots)
        .enter()
        .append("circle")
        .attr("class", "shots-circle")
        .attr("cx", d => xScaleLoc(d.location))
        .attr("cy", d => yScaleLoc(d.location))
        .attr("r", 4)
        .attr("data-team", d => d.team)
        .attr("data-player", d => d.player);

      gGoalsCircles.selectAll(".goals-circle")
        .data(goals)
        .enter()
        .append("circle")
        .attr("class", "goals-circle")
        .attr("cx", d => xScaleLoc(d.location))
        .attr("cy", d => yScaleLoc(d.location))
        .attr("r", 4)
        .attr("data-team", d => d.team)
        .attr("data-player", d => d.player);

      gPassesCircles.selectAll(".passes-circle")
        .data(passes)
        .enter()
        .append("circle")
        .attr("class", "passes-circle")
        .attr("cx", d => xScaleLoc(d.location))
        .attr("cy", d => yScaleLoc(d.location))
        .attr("r", 4)
        .attr("data-team", d => d.team)
        .attr("data-player", d => d.player);

      gAssistsCircles.selectAll(".assists-circle")
        .data(assists)
        .enter()
        .append("circle")
        .attr("class", "assists-circle")
        .attr("cx", d => xScaleLoc(d.location))
        .attr("cy", d => yScaleLoc(d.location))
        .attr("r", 4)
        .attr("data-team", d => d.team)
        .attr("data-player", d => d.player);

      // 4) Draw lines
      gShotsLines.selectAll(".shots-line")
        .data(shots)
        .enter()
        .append("line")
        .attr("class", "shots-line")
        .attr("x1", d => xScaleLoc(d.location))
        .attr("y1", d => yScaleLoc(d.location))
        .attr("x2", d => xScaleLoc(d.shot_end_location))
        .attr("y2", d => yScaleLoc(d.shot_end_location))
        .attr("data-team", d => d.team)
        .attr("data-player", d => d.player);

      gGoalsLines.selectAll(".goals-line")
        .data(goals)
        .enter()
        .append("line")
        .attr("class", "goals-line")
        .attr("x1", d => xScaleLoc(d.location))
        .attr("y1", d => yScaleLoc(d.location))
        .attr("x2", d => xScaleLoc(d.shot_end_location))
        .attr("y2", d => yScaleLoc(d.shot_end_location))
        .attr("data-team", d => d.team)
        .attr("data-player", d => d.player);

      gPassesLines.selectAll(".passes-line")
        .data(passes)
        .enter()
        .append("line")
        .attr("class", "passes-line")
        .attr("x1", d => xScaleLoc(d.location))
        .attr("y1", d => yScaleLoc(d.location))
        .attr("x2", d => xScaleLoc(d.pass_end_location))
        .attr("y2", d => yScaleLoc(d.pass_end_location))
        .attr("data-team", d => d.team)
        .attr("data-player", d => d.player);

      gAssistsLines.selectAll(".assists-line")
        .data(assists)
        .enter()
        .append("line")
        .attr("class", "assists-line")
        .attr("x1", d => xScaleLoc(d.location))
        .attr("y1", d => yScaleLoc(d.location))
        .attr("x2", d => xScaleLoc(d.pass_end_location))
        .attr("y2", d => yScaleLoc(d.pass_end_location))
        .attr("data-team", d => d.team)
        .attr("data-player", d => d.player);

      // Hide everything by default
      hideAllGroups();

      // Checkbox references
      const chkShots = document.getElementById("chkShots");
      const chkGoals = document.getElementById("chkGoals");
      const chkPasses = document.getElementById("chkPasses");
      const chkAssists = document.getElementById("chkAssists");
      const chkDirections = document.getElementById("chkDirections");

      // Dropdown references
      const teamSelectEl = document.getElementById("teamSelect");
      const playerSelectEl = document.getElementById("playerSelect");

      // Team -> Player filter logic
      teamSelectEl.addEventListener("change", function() {
        const selectedTeam = teamSelectEl.value;
        if (selectedTeam === "All") {
          updatePlayerDropdown(allPlayers);
        } else {
          const teamPlayers = data
            .filter(d => d.team === selectedTeam && d.player)
            .map(d => d.player);
          updatePlayerDropdown(Array.from(new Set(teamPlayers)).sort());
        }
        updateVisibility();
      });
      playerSelectEl.addEventListener("change", updateVisibility);

      // Checkbox changes
      chkShots.addEventListener("change", updateVisibility);
      chkGoals.addEventListener("change", updateVisibility);
      chkPasses.addEventListener("change", updateVisibility);
      chkAssists.addEventListener("change", updateVisibility);
      chkDirections.addEventListener("change", updateVisibility);

      function updateVisibility() {
        const selectedTeam = teamSelectEl.value;
        const selectedPlayer = playerSelectEl.value;

        // Shots
        gShotsCircles.style("display", chkShots.checked ? "inline" : "none");
        gShotsCircles.selectAll(".shots-circle").style("display", function() {
          return passesFilter(this, selectedTeam, selectedPlayer, chkShots.checked);
        });
        gShotsLines.style("display", (chkShots.checked && chkDirections.checked) ? "inline" : "none");
        gShotsLines.selectAll(".shots-line").style("display", function() {
          return passesFilter(this, selectedTeam, selectedPlayer, (chkShots.checked && chkDirections.checked));
        });

        // Goals
        gGoalsCircles.style("display", chkGoals.checked ? "inline" : "none");
        gGoalsCircles.selectAll(".goals-circle").style("display", function() {
          return passesFilter(this, selectedTeam, selectedPlayer, chkGoals.checked);
        });
        gGoalsLines.style("display", (chkGoals.checked && chkDirections.checked) ? "inline" : "none");
        gGoalsLines.selectAll(".goals-line").style("display", function() {
          return passesFilter(this, selectedTeam, selectedPlayer, (chkGoals.checked && chkDirections.checked));
        });

        // Passes
        gPassesCircles.style("display", chkPasses.checked ? "inline" : "none");
        gPassesCircles.selectAll(".passes-circle").style("display", function() {
          return passesFilter(this, selectedTeam, selectedPlayer, chkPasses.checked);
        });
        gPassesLines.style("display", (chkPasses.checked && chkDirections.checked) ? "inline" : "none");
        gPassesLines.selectAll(".passes-line").style("display", function() {
          return passesFilter(this, selectedTeam, selectedPlayer, (chkPasses.checked && chkDirections.checked));
        });

        // Assists
        gAssistsCircles.style("display", chkAssists.checked ? "inline" : "none");
        gAssistsCircles.selectAll(".assists-circle").style("display", function() {
          return passesFilter(this, selectedTeam, selectedPlayer, chkAssists.checked);
        });
        gAssistsLines.style("display", (chkAssists.checked && chkDirections.checked) ? "inline" : "none");
        gAssistsLines.selectAll(".assists-line").style("display", function() {
          return passesFilter(this, selectedTeam, selectedPlayer, (chkAssists.checked && chkDirections.checked));
        });
      }

      function passesFilter(element, teamVal, playerVal, isChecked) {
        if (!isChecked) return "none";
        const el = d3.select(element);
        const elTeam = el.attr("data-team");
        const elPlayer = el.attr("data-player");
        if (teamVal !== "All" && elTeam !== teamVal) return "none";
        if (playerVal !== "All" && elPlayer !== playerVal) return "none";
        return "inline";
      }

      function updatePlayerDropdown(players) {
        playerSelectEl.innerHTML = "";
        const optAll = document.createElement("option");
        optAll.value = "All";
        optAll.text = "All";
        playerSelectEl.appendChild(optAll);
        players.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p;
          opt.text = p;
          playerSelectEl.appendChild(opt);
        });
        playerSelectEl.value = "All";
      }

      // 6) Summaries: Top Scoring Players & Teams
      // Count how many times each player appears in 'goals'
      const playerGoalsMap = d3.rollups(goals, v => v.length, d => d.player);
      playerGoalsMap.sort((a, b) => d3.descending(a[1], b[1]));

      // Count how many times each team appears in 'goals'
      const teamGoalsMap = d3.rollups(goals, v => v.length, d => d.team);
      teamGoalsMap.sort((a, b) => d3.descending(a[1], b[1]));

      // Show top 5 scorers
      const playerList = d3.select("#playerList");
      playerGoalsMap.slice(0, 5).forEach(([player, goalCount]) => {
        if (player) {
          const li = playerList.append("li").text(`${player}: ${goalCount} goals`);
          li.on("click", () => {
            // Force filter to this player's goals
            teamSelectEl.value = "All";      // Clear team filter
            playerSelectEl.value = player;   // Set player filter
            // Force 'Goals' checkbox to be checked, uncheck others
            document.getElementById("chkShots").checked = false;
            document.getElementById("chkPasses").checked = false;
            document.getElementById("chkAssists").checked = false;
            document.getElementById("chkGoals").checked = true;
            updateVisibility();
          });
        }
      });

      // Show top 5 scoring teams
      const teamList = d3.select("#teamList");
      teamGoalsMap.slice(0, 5).forEach(([team, goalCount]) => {
        if (team) {
          const li = teamList.append("li").text(`${team}: ${goalCount} goals`);
          li.on("click", () => {
            // Force filter to this team's goals
            teamSelectEl.value = team;
            playerSelectEl.value = "All";
            // Force 'Goals' checkbox to be checked, uncheck others
            document.getElementById("chkShots").checked = false;
            document.getElementById("chkPasses").checked = false;
            document.getElementById("chkAssists").checked = false;
            document.getElementById("chkGoals").checked = true;
            updateVisibility();
          });
        }
      });
    })
    .catch(err => {
      console.error("Error loading JSON:", err);
    });

    function hideAllGroups() {
      gShotsCircles.style("display", "none");
      gShotsLines.style("display", "none");
      gGoalsCircles.style("display", "none");
      gGoalsLines.style("display", "none");
      gPassesCircles.style("display", "none");
      gPassesLines.style("display", "none");
      gAssistsCircles.style("display", "none");
      gAssistsLines.style("display", "none");
    }

    // Helper for scaling location
    function xScaleLoc(loc) {
      if (Array.isArray(loc) && loc.length >= 2) {
        return xScale(loc[0]);
      }
      return xScale(60);
    }
    function yScaleLoc(loc) {
      if (Array.isArray(loc) && loc.length >= 2) {
        return yScale(loc[1]);
      }
      return yScale(40);
    }

    // Draw standard pitch lines
    function drawPitchLines() {
      drawLine(0, 0, 120, 0);
      drawLine(120, 0, 120, 80);
      drawLine(120, 80, 0, 80);
      drawLine(0, 80, 0, 0);

      drawLine(60, 0, 60, 80);

      drawCircle(60, 40, 10);

      drawRect(0, 18, 18, 44);
      drawRect(0, 30, 6, 20);

      drawRect(102, 18, 18, 44);
      drawRect(114, 30, 6, 20);

      // Goals
      drawLine(0, 36, -2, 36);
      drawLine(0, 44, -2, 44);
      drawLine(120, 36, 122, 36);
      drawLine(120, 44, 122, 44);
    }

    function drawLine(x1, y1, x2, y2) {
      gPitchLines.append("line")
        .attr("x1", xScale(x1))
        .attr("y1", yScale(y1))
        .attr("x2", xScale(x2))
        .attr("y2", yScale(y2))
        .attr("class", "pitch-line");
    }

    function drawRect(x, y, w, h) {
      gPitchLines.append("rect")
        .attr("x", xScale(x))
        .attr("y", yScale(y))
        .attr("width", xScale(x + w) - xScale(x))
        .attr("height", yScale(y + h) - yScale(y))
        .attr("class", "pitch-line");
    }

    function drawCircle(cx, cy, r) {
      const rPixels = xScale(cx + r) - xScale(cx);
      gPitchLines.append("circle")
        .attr("cx", xScale(cx))
        .attr("cy", yScale(cy))
        .attr("r", rPixels)
        .attr("class", "pitch-line");
    }
  </script>
</body>
</html>
